<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Search</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        #controls {
            padding: 10px;
        }
        #paths-list {
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #paths-list li {
            display: flex;
            align-items: center;
        }
        #paths-list label {
            margin-left: 5px;
        }
        #search-input {
            height: 40px;
            font-size: 16px;
            width: 300px;
        }
        #search-button, #search-plus-button {
            height: 46px;
            margin-left: 10px;
        }
        #graph-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background: #f5f5f5;
            cursor: grab;
        }
        #graph {
            position: absolute;
            left: 0;
            top: 0;
            transform-origin: 0 0;
        }
        .node {
            position: absolute;
            width: 200px;
            height: 120px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            background: #fff;
            box-sizing: border-box;
            font-size: 12px;
        }
        #lines-canvas {
            position: absolute;
            left: 0;
            top: 0;
            pointer-events: none;
            transform-origin: 0 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="utils.js"></script>
</head>
<body>
    <div id="controls">
        <input type="text" id="search-input" placeholder="Enter your search query">
        <button id="search-button">Search</button>
        <button id="search-plus-button">Search+</button>
        <ul id="paths-list"></ul>
    </div>
    <div id="graph-wrapper">
        <svg id="lines-canvas"></svg>
        <div id="graph"></div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const pathsList = document.getElementById('paths-list');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchPlusButton = document.getElementById('search-plus-button');
        const graphWrapper = document.getElementById('graph-wrapper');
        const graph = document.getElementById('graph');
        const svg = document.getElementById('lines-canvas');

        let offsetX = 0, offsetY = 0;
        let scale = 1;
        let isPanning = false;
        let startX = 0, startY = 0;

        function setTransform() {
            graph.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            svg.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }

        function resizeCanvas() {
            svg.setAttribute('width', graphWrapper.clientWidth);
            svg.setAttribute('height', graphWrapper.clientHeight);
        }

        window.addEventListener('resize', function() {
            resizeCanvas();
            scale = 1;
            offsetX = graphWrapper.clientWidth / 2;
            offsetY = graphWrapper.clientHeight / 2;
            setTransform();
        });

        graphWrapper.addEventListener('mousedown', function(e) {
            if (e.target !== graphWrapper) return;
            isPanning = true;
            startX = e.clientX;
            startY = e.clientY;
            graphWrapper.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isPanning) return;
            offsetX += e.clientX - startX;
            offsetY += e.clientY - startY;
            startX = e.clientX;
            startY = e.clientY;
            setTransform();
        });

        document.addEventListener('mouseup', function() {
            isPanning = false;
            graphWrapper.style.cursor = 'grab';
        });

        const minScale = 0.5;
        const maxScale = 3;
        graphWrapper.addEventListener('wheel', function(e) {
            e.preventDefault();
            const delta = e.deltaY < 0 ? 1.1 : 0.9;
            scale *= delta;
            if (scale < minScale) scale = minScale;
            if (scale > maxScale) scale = maxScale;
            setTransform();
        }, { passive: false });

        fetch('http://localhost:4567/paths')
            .then(resp => resp.json())
            .then(data => {
                data.forEach(item => {
                    const li = document.createElement('li');
                    applyBackgroundColor(li, item.name);
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = item.name;
                    checkbox.name = item.name;
                    checkbox.checked = !!item.searchDefault;
                    const label = document.createElement('label');
                    label.htmlFor = item.name;
                    label.textContent = item.name;
                    li.appendChild(checkbox);
                    li.appendChild(label);
                    pathsList.appendChild(li);
                });
            });

        function selectedPaths() {
            return Array.from(pathsList.querySelectorAll('input[type="checkbox"]:checked')).map(c => c.name);
        }

        let currentItems = [];
        let itemSet = new Set();
        let nodes = [];
        let links = [];
        let simulation = null;

        function addNode(item, isQuery=false) {
            const n = {
                id: isQuery ? 'query' : item.url,
                item: item
            };
            const div = document.createElement('div');
            div.className = 'node';
            if (isQuery) {
                div.innerHTML = `<strong>${item}</strong>`;
            } else {
                applyBackgroundColor(div, item.lookup);
                div.dataset.note = item.text;
                div.innerHTML = `\n                    <div><strong>Path:</strong> <a href="${item.url}">${item.id}</a></div>\n                    <div><strong>Score:</strong> ${item.score}</div>\n                    <div class="markdown-content">${marked.parse(item.text)}</div>\n                `;
                div.addEventListener('dblclick', () => fetchSimilar(n));
            }
            graph.appendChild(div);
            n.div = div;
            nodes.push(n);
            return n;
        }

        function startSimulation() {
            if (simulation) simulation.stop();
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links)
                    .id(d => d.id)
                    .distance(d => Math.max(50, 200 * (1 - (d.score || 0))))
                    .strength(d => Math.max(0.1, d.score || 0)))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(0, 0));

            simulation.on('tick', () => {
                d3.select(svg).selectAll('line')
                    .data(links)
                    .join('line')
                    .attr('stroke', '#999')
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodes.forEach(n => {
                    if (!n.div) return;
                    n.div.style.left = `${n.x - 100}px`;
                    n.div.style.top = `${n.y - 60}px`;
                });
            });
        }

        function renderGraph(items) {
            currentItems = items.slice();
            itemSet = new Set(items.map(it => it.url));
            nodes = [];
            links = [];
            graph.innerHTML = '';
            svg.innerHTML = '';

            resizeCanvas();
            offsetX = graphWrapper.clientWidth / 2;
            offsetY = graphWrapper.clientHeight / 2;
            setTransform();

            const qNode = addNode(searchInput.value, true);
            items.forEach(it => {
                const n = addNode(it);
                links.push({ source: qNode, target: n, score: it.score });
            });

            startSimulation();
        }

        function addItems(newItems, parentNode) {
            let changed = false;
            newItems.forEach(it => {
                let target = nodes.find(n => n.id === it.url);
                if (!target) {
                    target = addNode(it);
                    itemSet.add(it.url);
                    currentItems.push(it);
                    changed = true;
                }
                if (parentNode) {
                    links.push({ source: parentNode, target: target, score: it.score });
                    changed = true;
                }
            });
            if (changed) startSimulation();
        }

        function fetchSimilar(node) {
            fetch('http://localhost:4567/similar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paths: selectedPaths(), note: node.item.text, topN: 3 })
            }).then(resp => resp.json())
              .then(resp => {
                  addItems(resp.data, node);
              });
        }

        function performSearch(url) {
            const query = searchInput.value;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: query, paths: selectedPaths() })
            }).then(resp => resp.json())
              .then(resp => { renderGraph(resp.data); });
        }

        searchButton.addEventListener('click', () => performSearch('http://localhost:4567/q'));
        searchPlusButton.addEventListener('click', () => performSearch('http://localhost:4567/q_plus'));
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { performSearch('http://localhost:4567/q'); }
        });

    });
</script>
</body>
</html>
